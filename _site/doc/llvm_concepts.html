
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>LLVM Concepts</title>
    
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/stylesheets/pygment_trac.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">llvm-py Documentation</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
  <h1>LLVM Concepts </h1>
</div>

<div class="row">
  <div class="span12">
    <p>This section explains a few concepts related to LLVM, not specific to llvm-py.</p>

<h1 id='intermediate_representation'>Intermediate Representation</h1>

<p>The intermediate representation, or IR for short, is an in-memory data structure that represents executable code. The IR data structures allow for creation of types, constants, functions, function arguments, instructions, global variables and so on. For example, to create a function <em>sum</em> that takes two integers and returns their sum, we need to follow these steps:</p>

<ul>
<li>create an integer type <em>ti</em> of required bitwidth</li>

<li>create a function type <em>tf</em> which takes two <em>ti</em> -s and returns another <em>ti</em></li>

<li>create a function of type <em>tf</em> named <em>sum</em></li>

<li>add a <em>basic block</em> to the function</li>

<li>using a helper object called an <em>instruction builder</em>, add two instructions into the basic block: . an instruction to add the two arguments and store the result into a temporary variable . a return instruction to return the value of the temporary variable</li>
</ul>

<p>(A basic block is a block of instructions.)</p>

<p>LLVM has it&#8217;s own instruction set; the instructions used above (<em>add</em> and <em>ret</em>) are from this set. The LLVM instructions are at a higher level than the usual assembly language; for example there are instructions related to variable argument handling, exception handling, and garbage collection. These allow high-level languages to be represented cleanly in the IR.</p>
<hr />
<h1 id='ssa_form_and_phi_nodes'>SSA Form and PHI Nodes</h1>

<p>All LLVM instructions are represented in the <em>Static Single Assignment</em> (SSA) form. Essentially, this means that any variable can be assigned to only once. Such a representation facilitates better optimization, among other benefits.</p>

<p>A consequence of single assignment are PHI (&#934;) nodes. These are required when a variable can be assigned a different value based on the path of control flow. For example, the value of <em>b</em> at the end of execution of the snippet below:</p>
<div class='highlight'><pre><code class='c'><span class='n'>a</span> <span class='o'>=</span> <span class='mi'>1</span><span class='p'>;</span>
<span class='k'>if</span> <span class='p'>(</span><span class='n'>v</span> <span class='o'>&lt;</span> <span class='mi'>10</span><span class='p'>)</span>
  <span class='n'>a</span> <span class='o'>=</span> <span class='mi'>2</span><span class='p'>;</span>
<span class='n'>b</span> <span class='o'>=</span> <span class='n'>a</span><span class='p'>;</span>
</code></pre>
</div>
<p>cannot be determined statically. The value of &#8216;2&#8217; cannot be assigned to the &#8216;original&#8217; <em>a</em>, since <em>a</em> can be assigned to only once. There are two <em>a</em> &#8216;s in there, and the last assignment has to choose between which version to pick. This is accomplished by adding a PHI node:</p>
<div class='highlight'><pre><code class='c'><span class='n'>a1</span> <span class='o'>=</span> <span class='mi'>1</span><span class='p'>;</span>
<span class='k'>if</span> <span class='p'>(</span><span class='n'>v</span> <span class='o'>&lt;</span> <span class='mi'>10</span><span class='p'>)</span>
  <span class='n'>a2</span> <span class='o'>=</span> <span class='mi'>2</span><span class='p'>;</span>
<span class='n'>b</span> <span class='o'>=</span> <span class='n'>PHI</span><span class='p'>(</span><span class='n'>a1</span><span class='p'>,</span> <span class='n'>a2</span><span class='p'>);</span>
</code></pre>
</div>
<p>The PHI node selects <em>a1</em> or <em>a2</em>, depending on where the control reached the PHI node. The argument <em>a1</em> of the PHI node is associated with the block <em>&#8220;a1 = 1;&#8221;</em> and <em>a2</em> with the block <em>&#8220;a2 = 2;&#8221;</em>.</p>

<p>PHI nodes have to be explicitly created in the LLVM IR. Accordingly the LLVM instruction set has an instruction called <em>phi</em>.</p>
<hr />
<h1 id='llvm_assembly_language'>LLVM Assembly Language</h1>

<p>The LLVM IR can be represented offline in two formats</p>

<ul>
<li>a textual, human-readable form, similar to assembly language, called the LLVM assembly language (files with .ll extension)</li>

<li>a binary form, called the LLVM bitcode (files with .bc extension)</li>
</ul>

<p>All three formats (the in-memory IR, the LLVM assembly language and the LLVM bitcode) represent the <em>same</em> information. Each format can be converted into the other two formats (using LLVM APIs).</p>

<p>The <a href='http://www.llvm.org/demo/'>LLVM demo page</a> lets you type in C or C++ code, converts it into LLVM IR and outputs the IR as LLVM assembly language code.</p>

<p>Just to get a feel of the LLVM assembly language, here&#8217;s a function in C, and the corresponding LLVM assembly (as generated by the demo page):</p>
<div class='highlight'><pre><code class='c'><span class='cm'>/* compute sum of 1..n */</span>
<span class='kt'>unsigned</span> <span class='nf'>sum</span><span class='p'>(</span><span class='kt'>unsigned</span> <span class='n'>n</span><span class='p'>)</span>
<span class='p'>{</span>
  <span class='k'>if</span> <span class='p'>(</span><span class='n'>n</span> <span class='o'>==</span> <span class='mi'>0</span><span class='p'>)</span>
    <span class='k'>return</span> <span class='mi'>0</span><span class='p'>;</span>
  <span class='k'>else</span>
    <span class='k'>return</span> <span class='n'>n</span> <span class='o'>+</span> <span class='n'>sum</span><span class='p'>(</span><span class='n'>n</span><span class='o'>-</span><span class='mi'>1</span><span class='p'>);</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>The corresponding LLVM assembly:</p>
<div class='highlight'><pre><code class='llvm'><span class='c'>; ModuleID = &#39;/tmp/webcompile/_7149_0.bc&#39;</span>
<span class='k'>target</span> <span class='k'>datalayout</span> <span class='p'>=</span> <span class='s'>&quot;e-p:64:64:64-i1:8:8-i8:8:8-i16:16:16-i32:32:32-i64:64:64-f32:32:32-f64:64:64-v64:64:64-v128:128:128-a0:0:64-s0:64:64-f80:128:128-n8:16:32:64&quot;</span>
<span class='k'>target</span> <span class='k'>triple</span> <span class='p'>=</span> <span class='s'>&quot;x86_64-linux-gnu&quot;</span>

<span class='k'>define</span> <span class='k'>i32</span> <span class='vg'>@sum</span><span class='p'>(</span><span class='k'>i32</span> <span class='nv'>%n</span><span class='p'>)</span> <span class='k'>nounwind</span> <span class='k'>readnone</span> <span class='p'>{</span>
<span class='nl'>entry:</span>
  <span class='nv-Anonymous'>%0</span> <span class='p'>=</span> <span class='k'>icmp</span> <span class='k'>eq</span> <span class='k'>i32</span> <span class='nv'>%n</span><span class='p'>,</span> <span class='m'>0</span>                          <span class='c'>; &lt;i1&gt; [#uses=1]</span>
  <span class='k'>br</span> <span class='k'>i1</span> <span class='nv-Anonymous'>%0</span><span class='p'>,</span> <span class='kt'>label</span> <span class='nv'>%bb2</span><span class='p'>,</span> <span class='kt'>label</span> <span class='nv'>%bb1</span>

<span class='nl'>bb1:</span>                                              <span class='c'>; preds = %entry</span>
  <span class='nv-Anonymous'>%1</span> <span class='p'>=</span> <span class='k'>add</span> <span class='k'>i32</span> <span class='nv'>%n</span><span class='p'>,</span> <span class='m'>-1</span>                             <span class='c'>; &lt;i32&gt; [#uses=2]</span>
  <span class='nv-Anonymous'>%2</span> <span class='p'>=</span> <span class='k'>icmp</span> <span class='k'>eq</span> <span class='k'>i32</span> <span class='nv-Anonymous'>%1</span><span class='p'>,</span> <span class='m'>0</span>                          <span class='c'>; &lt;i1&gt; [#uses=1]</span>
  <span class='k'>br</span> <span class='k'>i1</span> <span class='nv-Anonymous'>%2</span><span class='p'>,</span> <span class='kt'>label</span> <span class='nv'>%sum.exit</span><span class='p'>,</span> <span class='kt'>label</span> <span class='nv'>%bb1.i</span>

<span class='nl'>bb1.i:</span>                                            <span class='c'>; preds = %bb1</span>
  <span class='nv-Anonymous'>%3</span> <span class='p'>=</span> <span class='k'>add</span> <span class='k'>i32</span> <span class='nv'>%n</span><span class='p'>,</span> <span class='m'>-2</span>                             <span class='c'>; &lt;i32&gt; [#uses=1]</span>
  <span class='nv-Anonymous'>%4</span> <span class='p'>=</span> <span class='k'>tail</span> <span class='k'>call</span> <span class='k'>i32</span> <span class='vg'>@sum</span><span class='p'>(</span><span class='k'>i32</span> <span class='nv-Anonymous'>%3</span><span class='p'>)</span> <span class='k'>nounwind</span>        <span class='c'>; &lt;i32&gt; [#uses=1]</span>
  <span class='nv-Anonymous'>%5</span> <span class='p'>=</span> <span class='k'>add</span> <span class='k'>i32</span> <span class='nv-Anonymous'>%4</span><span class='p'>,</span> <span class='nv-Anonymous'>%1</span>                             <span class='c'>; &lt;i32&gt; [#uses=1]</span>
  <span class='k'>br</span> <span class='kt'>label</span> <span class='nv'>%sum.exit</span>

<span class='nl'>sum.exit:</span>                                         <span class='c'>; preds = %bb1.i, %bb1</span>
  <span class='nv-Anonymous'>%6</span> <span class='p'>=</span> <span class='k'>phi</span> <span class='k'>i32</span> <span class='p'>[</span> <span class='nv-Anonymous'>%5</span><span class='p'>,</span> <span class='nv'>%bb1.i</span> <span class='p'>],</span> <span class='p'>[</span> <span class='m'>0</span><span class='p'>,</span> <span class='nv'>%bb1</span> <span class='p'>]</span>        <span class='c'>; &lt;i32&gt; [#uses=1]</span>
  <span class='nv-Anonymous'>%7</span> <span class='p'>=</span> <span class='k'>add</span> <span class='k'>i32</span> <span class='nv-Anonymous'>%6</span><span class='p'>,</span> <span class='nv'>%n</span>                             <span class='c'>; &lt;i32&gt; [#uses=1]</span>
  <span class='k'>ret</span> <span class='k'>i32</span> <span class='nv-Anonymous'>%7</span>

<span class='nl'>bb2:</span>                                              <span class='c'>; preds = %entry</span>
  <span class='k'>ret</span> <span class='k'>i32</span> <span class='m'>0</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Note the usage of SSA form. The long string called <code>target datalayout</code> is a specification of the platform ABI (like endianness, sizes of types, alignment etc.).</p>

<p>The <a href='http://www.llvm.org/docs/LangRef.html'>LLVM Language Reference</a> defines the LLVM assembly language including the entire instruction set.</p>
<hr />
<h1 id='modules'>Modules</h1>

<p><a href='./llvm.core.Module.html'>Modules</a>, in the LLVM IR, are similar to a single <em>C</em> language source file (.c file). A module contains:</p>

<ul>
<li>functions (declarations and definitions)</li>

<li>global variables and constants</li>

<li>global type aliases (typedef-s)</li>
</ul>

<p>Modules are top-level containers; all executable code representation is contained within modules. Modules may be combined (linked) together to give a bigger resultant module. During this process LLVM attempts to reconcile the references between the combined modules.</p>
<hr />
<h1 id='optimization_and_passes'>Optimization and Passes</h1>

<p>LLVM provides quite a few optimization algorithms that work on the IR. These algorithms are organized as <em>passes</em>. Each pass does something specific, like combining redundant instructions. Passes need not always optimize the IR, it can also do other operations like inserting instrumentation code, or analysing the IR (the result of which can be used by passes that do optimizations) or even printing call graphs.</p>

<p>This LLVM <a href='http://www.llvm.org/docs/Passes.html'>documentation page</a> describes all the available passes, and what they do.</p>

<p>LLVM does not automatically choose to run any passes, anytime. Passes have to be explicitly selected and run on each module. This gives you the flexibility to choose transformations and optimizations that are most suitable for the code in the module.</p>

<p>There is an LLVM binary called <a href='http://www.llvm.org/cmds/opt.html'>opt</a>, which lets you run passes on bitcode files from the command line. You can write your own passes (in C/C++, as a shared library). This can be loaded and executed by +opt+. (Although llvm-py does not allow you to write your own passes, it does allow you to navigate the entire IR at any stage, and perform any transforms on it as you like.)</p>

<p>A &#8220;pass manager&#8221; is responsible for loading passes, selecting the correct objects to run them on (for example, a pass may work only on functions, individually) and actually runs them. <code>opt</code> is a command-line wrapper for the pass manager.</p>
<hr />
<h1 id='bit_code'>Bit code</h1>

<p>TODO</p>
<hr />
<h1 id='execution_engine_jit_and_interpreter'>Execution Engine, JIT and Interpreter</h1>

<p>TODO</p>
<hr />
<p><strong>Next</strong> &#8211; <a href='./llvm-py_package.html'>llvm-py Package</a></p>
  </div>
</div>


      </div>

      <footer>
        <p>&copy;  2012
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  </body>
</html>

