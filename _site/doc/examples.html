
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Examples and LLVM Tutorials</title>
    
    <meta name="author" content="">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/stylesheets/pygment_trac.css" rel="stylesheet" type="text/css">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>

    <div class="navbar">
      <div class="navbar-inner">
        <div class="container">
          <a class="brand" href="/">llvm-py Documentation</a>
          <ul class="nav">
            
            
            


  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
  <h1>Examples and LLVM Tutorials </h1>
</div>

<div class="row">
  <div class="span12">
    <div class='maruku_toc'><ul style='list-style: none;'><li><a href='#examples'>Examples</a><ul style='list-style: none;'><li><a href='#a_simple_function'>A Simple Function</a></li><li><a href='#adding_jit_compilation'>Adding JIT Compilation</a></li></ul></li><li><a href='#llvm_tutorials'>LLVM Tutorials</a><ul style='list-style: none;'><li><a href='#simple_jit_tutorials'>Simple JIT Tutorials</a></li><li><a href='#kaleidoscope'>Kaleidoscope</a></li></ul></li></ul></div>
<h1 id='examples'>Examples</h1>

<h2 id='a_simple_function'>A Simple Function</h2>

<p>Let&#8217;s create a (LLVM) module containing a single function, corresponding to the <code>C</code> function:</p>
<div class='highlight'><pre><code class='c'><span class='kt'>int</span> <span class='nf'>sum</span><span class='p'>(</span><span class='kt'>int</span> <span class='n'>a</span><span class='p'>,</span> <span class='kt'>int</span> <span class='n'>b</span><span class='p'>)</span>
<span class='p'>{</span>
    <span class='k'>return</span> <span class='n'>a</span> <span class='o'>+</span> <span class='n'>b</span><span class='p'>;</span>
<span class='p'>}</span>
</code></pre>
</div>
<p>Here&#8217;s how it looks like:</p>
<div class='highlight'><pre><code class='python'><span class='c'>#!/usr/bin/env python</span>

<span class='c'># Import the llvm-py modules.</span>
<span class='kn'>from</span> <span class='nn'>llvm</span> <span class='kn'>import</span> <span class='o'>*</span>
<span class='kn'>from</span> <span class='nn'>llvm.core</span> <span class='kn'>import</span> <span class='o'>*</span>

<span class='c'># Create an (empty) module.</span>
<span class='n'>my_module</span> <span class='o'>=</span> <span class='n'>Module</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='s'>&#39;my_module&#39;</span><span class='p'>)</span>

<span class='c'># All the types involved here are &quot;int&quot;s. This type is represented</span>
<span class='c'># by an object of the llvm.core.Type class:</span>
<span class='n'>ty_int</span> <span class='o'>=</span> <span class='n'>Type</span><span class='o'>.</span><span class='n'>int</span><span class='p'>()</span>   <span class='c'># by default 32 bits</span>

<span class='c'># We need to represent the class of functions that accept two integers</span>
<span class='c'># and return an integer. This is represented by an object of the</span>
<span class='c'># function type (llvm.core.FunctionType):</span>
<span class='n'>ty_func</span> <span class='o'>=</span> <span class='n'>Type</span><span class='o'>.</span><span class='n'>function</span><span class='p'>(</span><span class='n'>ty_int</span><span class='p'>,</span> <span class='p'>[</span><span class='n'>ty_int</span><span class='p'>,</span> <span class='n'>ty_int</span><span class='p'>])</span>

<span class='c'># Now we need a function named &#39;sum&#39; of this type. Functions are not</span>
<span class='c'># free-standing (in llvm-py); it needs to be contained in a module.</span>
<span class='n'>f_sum</span> <span class='o'>=</span> <span class='n'>my_module</span><span class='o'>.</span><span class='n'>add_function</span><span class='p'>(</span><span class='n'>ty_func</span><span class='p'>,</span> <span class='s'>&quot;sum&quot;</span><span class='p'>)</span>

<span class='c'># Let&#39;s name the function arguments as &#39;a&#39; and &#39;b&#39;.</span>
<span class='n'>f_sum</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]</span><span class='o'>.</span><span class='n'>name</span> <span class='o'>=</span> <span class='s'>&quot;a&quot;</span>
<span class='n'>f_sum</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>]</span><span class='o'>.</span><span class='n'>name</span> <span class='o'>=</span> <span class='s'>&quot;b&quot;</span>

<span class='c'># Our function needs a &quot;basic block&quot; -- a set of instructions that</span>
<span class='c'># end with a terminator (like return, branch etc.). By convention</span>
<span class='c'># the first block is called &quot;entry&quot;.</span>
<span class='n'>bb</span> <span class='o'>=</span> <span class='n'>f_sum</span><span class='o'>.</span><span class='n'>append_basic_block</span><span class='p'>(</span><span class='s'>&quot;entry&quot;</span><span class='p'>)</span>

<span class='c'># Let&#39;s add instructions into the block. For this, we need an</span>
<span class='c'># instruction builder:</span>
<span class='n'>builder</span> <span class='o'>=</span> <span class='n'>Builder</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='n'>bb</span><span class='p'>)</span>

<span class='c'># OK, now for the instructions themselves. We&#39;ll create an add</span>
<span class='c'># instruction that returns the sum as a value, which we&#39;ll use</span>
<span class='c'># a ret instruction to return.</span>
<span class='n'>tmp</span> <span class='o'>=</span> <span class='n'>builder</span><span class='o'>.</span><span class='n'>add</span><span class='p'>(</span><span class='n'>f_sum</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>],</span> <span class='n'>f_sum</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>],</span> <span class='s'>&quot;tmp&quot;</span><span class='p'>)</span>
<span class='n'>builder</span><span class='o'>.</span><span class='n'>ret</span><span class='p'>(</span><span class='n'>tmp</span><span class='p'>)</span>

<span class='c'># We&#39;ve completed the definition now! Let&#39;s see the LLVM assembly</span>
<span class='c'># language representation of what we&#39;ve created:</span>
<span class='k'>print</span> <span class='n'>my_module</span>
</code></pre>
</div>
<p>Here is the output:</p>
<div class='highlight'><pre><code class='llvm'><span class='c'>; ModuleID = &#39;my_module&#39;</span>

<span class='k'>define</span> <span class='k'>i32</span> <span class='vg'>@sum</span><span class='p'>(</span><span class='k'>i32</span> <span class='nv'>%a</span><span class='p'>,</span> <span class='k'>i32</span> <span class='nv'>%b</span><span class='p'>)</span> <span class='p'>{</span>
<span class='nl'>entry:</span>
        <span class='nv'>%tmp</span> <span class='p'>=</span> <span class='k'>add</span> <span class='k'>i32</span> <span class='nv'>%a</span><span class='p'>,</span> <span class='nv'>%b</span>           <span class='c'>; &lt;i32&gt; [#uses=1]</span>
        <span class='k'>ret</span> <span class='k'>i32</span> <span class='nv'>%tmp</span>
<span class='p'>}</span>
</code></pre>
</div>
<h2 id='adding_jit_compilation'>Adding JIT Compilation</h2>

<p>Let&#8217;s compile this function in-memory and run it.</p>
<div class='highlight'><pre><code class='python'><span class='c'>#!/usr/bin/env python</span>

<span class='c'># Import the llvm-py modules.</span>
<span class='kn'>from</span> <span class='nn'>llvm</span> <span class='kn'>import</span> <span class='o'>*</span>
<span class='kn'>from</span> <span class='nn'>llvm.core</span> <span class='kn'>import</span> <span class='o'>*</span>
<span class='kn'>from</span> <span class='nn'>llvm.ee</span> <span class='kn'>import</span> <span class='o'>*</span>          <span class='c'># new import: ee = Execution Engine</span>

<span class='c'># Create a module, as in the previous example.</span>
<span class='n'>my_module</span> <span class='o'>=</span> <span class='n'>Module</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='s'>&#39;my_module&#39;</span><span class='p'>)</span>
<span class='n'>ty_int</span> <span class='o'>=</span> <span class='n'>Type</span><span class='o'>.</span><span class='n'>int</span><span class='p'>()</span>   <span class='c'># by default 32 bits</span>
<span class='n'>ty_func</span> <span class='o'>=</span> <span class='n'>Type</span><span class='o'>.</span><span class='n'>function</span><span class='p'>(</span><span class='n'>ty_int</span><span class='p'>,</span> <span class='p'>[</span><span class='n'>ty_int</span><span class='p'>,</span> <span class='n'>ty_int</span><span class='p'>])</span>
<span class='n'>f_sum</span> <span class='o'>=</span> <span class='n'>my_module</span><span class='o'>.</span><span class='n'>add_function</span><span class='p'>(</span><span class='n'>ty_func</span><span class='p'>,</span> <span class='s'>&quot;sum&quot;</span><span class='p'>)</span>
<span class='n'>f_sum</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>]</span><span class='o'>.</span><span class='n'>name</span> <span class='o'>=</span> <span class='s'>&quot;a&quot;</span>
<span class='n'>f_sum</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>]</span><span class='o'>.</span><span class='n'>name</span> <span class='o'>=</span> <span class='s'>&quot;b&quot;</span>
<span class='n'>bb</span> <span class='o'>=</span> <span class='n'>f_sum</span><span class='o'>.</span><span class='n'>append_basic_block</span><span class='p'>(</span><span class='s'>&quot;entry&quot;</span><span class='p'>)</span>
<span class='n'>builder</span> <span class='o'>=</span> <span class='n'>Builder</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='n'>bb</span><span class='p'>)</span>
<span class='n'>tmp</span> <span class='o'>=</span> <span class='n'>builder</span><span class='o'>.</span><span class='n'>add</span><span class='p'>(</span><span class='n'>f_sum</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>0</span><span class='p'>],</span> <span class='n'>f_sum</span><span class='o'>.</span><span class='n'>args</span><span class='p'>[</span><span class='mi'>1</span><span class='p'>],</span> <span class='s'>&quot;tmp&quot;</span><span class='p'>)</span>
<span class='n'>builder</span><span class='o'>.</span><span class='n'>ret</span><span class='p'>(</span><span class='n'>tmp</span><span class='p'>)</span>

<span class='c'># Create an execution engine object. This will create a JIT compiler</span>
<span class='c'># on platforms that support it, or an interpreter otherwise.</span>
<span class='n'>ee</span> <span class='o'>=</span> <span class='n'>ExecutionEngine</span><span class='o'>.</span><span class='n'>new</span><span class='p'>(</span><span class='n'>my_module</span><span class='p'>)</span>

<span class='c'># The arguments needs to be passed as &quot;GenericValue&quot; objects.</span>
<span class='n'>arg1</span> <span class='o'>=</span> <span class='n'>GenericValue</span><span class='o'>.</span><span class='n'>int</span><span class='p'>(</span><span class='n'>ty_int</span><span class='p'>,</span> <span class='mi'>100</span><span class='p'>)</span>
<span class='n'>arg2</span> <span class='o'>=</span> <span class='n'>GenericValue</span><span class='o'>.</span><span class='n'>int</span><span class='p'>(</span><span class='n'>ty_int</span><span class='p'>,</span> <span class='mi'>42</span><span class='p'>)</span>

<span class='c'># Now let&#39;s compile and run!</span>
<span class='n'>retval</span> <span class='o'>=</span> <span class='n'>ee</span><span class='o'>.</span><span class='n'>run_function</span><span class='p'>(</span><span class='n'>f_sum</span><span class='p'>,</span> <span class='p'>[</span><span class='n'>arg1</span><span class='p'>,</span> <span class='n'>arg2</span><span class='p'>])</span>

<span class='c'># The return value is also GenericValue. Let&#39;s print it.</span>
<span class='k'>print</span> <span class='s'>&quot;returned&quot;</span><span class='p'>,</span> <span class='n'>retval</span><span class='o'>.</span><span class='n'>as_int</span><span class='p'>()</span>
</code></pre>
</div>
<p>And here&#8217;s the output:</p>

<pre><code>returned 142</code></pre>
<hr />
<h1 id='llvm_tutorials'>LLVM Tutorials</h1>

<h2 id='simple_jit_tutorials'>Simple JIT Tutorials</h2>

<p>The following JIT tutorials were contributed by Sebastien Binet.</p>

<ol>
<li><a href='examples/JITTutorial1.html'>A First Function</a></li>

<li><a href='examples/JITTutorial2.html'>A More Complicated Function</a></li>
</ol>

<h2 id='kaleidoscope'>Kaleidoscope</h2>

<p>Implementing a Language with LLVM</p>

<p>The LLVM <a href='http://www.llvm.org/docs/tutorial/'>Kaleidoscope</a> tutorial has been ported to llvm-py by Max Shawabkeh.</p>

<ol>
<li><a href='kaleidoscope/PythonLangImpl1.html'>Tutorial Introduction and the Lexer</a></li>

<li><a href='kaleidoscope/PythonLangImpl2.html'>Implementing a Parser and AST</a></li>

<li><a href='kaleidoscope/PythonLangImpl3.html'>Implementing Code Generation to LLVM IR</a></li>

<li><a href='kaleidoscope/PythonLangImpl4.html'>Adding JIT and Optimizer Support</a></li>

<li><a href='kaleidoscope/PythonLangImpl5.html'>Extending the language: control flow</a></li>

<li><a href='kaleidoscope/PythonLangImpl6.html'>Extending the language: user-defined operators</a></li>

<li><a href='kaleidoscope/PythonLangImpl7.html'>Extending the language: mutable variables / SSA construction</a></li>

<li><a href='kaleidoscope/PythonLangImpl8.html'>Conclusion and other useful LLVM tidbits</a></li>
</ol>
  </div>
</div>


      </div>

      <footer>
        <p>&copy;  2012
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  </body>
</html>

